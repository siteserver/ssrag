@page
@{ Layout = "_Layout"; }
@section Styles{
<link rel="stylesheet" href="/sitefiles/assets/lib/ueditor/third-party/custom/custom.css">
<style>
  .commands {
    text-align: right;
    padding-right: 10px;
  }

  .el-button-group .el-dropdown {
    float: left;
    margin-top: -1px;
    margin-right: -1px;
  }
</style>
}

<el-row>
  <el-col :span="20">
    <el-form v-on:submit.native.prevent size="mini" :inline="true">
      <el-form-item label="关键字">
        <el-input v-model="filterText" placeholder="请输入栏目名称/栏目Id"></el-input>
      </el-form-item>
    </el-form>
  </el-col>
  <el-col :span="4" align="right">

  </el-col>
</el-row>

<div class="el-table el-table--fit el-table--enable-row-hover el-table--enable-row-transition" style="width: 100%;">
  <div class="hidden-columns">
    <div></div>
    <div v-for="column in columns" v-if="column.isList && column.attributeName !== 'ChannelName'"
      :key="column.attributeName">
    </div>
    <div></div>
  </div>
  <div class="el-table__header-wrapper">
    <table cellspacing="0" cellpadding="0" border="0" class="el-table__header" style="width: 100%;">
      <colgroup>
        <col>
        <col v-for="column in columns" v-if="column.isList && column.attributeName !== 'ChannelName'"
          :key="column.attributeName" :width="getColumnWidth(column.attributeName)">
        <col :width="commandsWidth">
      </colgroup>
      <thead class="has-gutter">
        <tr class="">
          <th colspan="1" rowspan="1" class="is-leaf">
            <div class="cell" style="text-align: left;">栏目名称（提示：可以对栏目进行拖拽操作）</div>
          </th>
          <th v-for="column in columns" v-if="column.isList && column.attributeName !== 'ChannelName'"
            :key="column.attributeName" colspan="1" rowspan="1" class="is-leaf">
            <div class="cell">{{ column.displayName }}</div>
          </th>
          <th colspan="1" rowspan="1" class="is-leaf">
            <div class="cell"></div>
          </th>
        </tr>
      </thead>
    </table>
  </div>
  <div class="el-table__column-resize-proxy" style="display: none;"></div>
</div>

<el-tree ref="tree" class="tree" node-key="value" draggable show-checkbox check-strictly highlight-current :data="root"
  :default-expanded-keys="expandedChannelIds" :filter-node-method="filterNode" :allow-drop="allowDrop"
  :allow-drag="allowDrag" v-on:node-drop="handleDrop" v-on:check-change="handleCheckChange">
  <div class="el-table__body-wrapper is-scrolling-none" slot-scope="{ node, data }">
    <table v-on:dblclick="btnEditClick(data)" v-on:click.ctrl.stop="btnCheckClick(data)" cellspacing="0" cellpadding="0"
      border="0" class="el-table__body" style="width: 100%;">
      <colgroup>
        <col>
        <col v-for="column in columns" v-if="column.isList && column.attributeName !== 'ChannelName'"
          :key="column.attributeName" :width="getColumnWidth(column.attributeName)">
        <col :width="commandsWidth">
      </colgroup>
      <tbody>
        <tr class="el-table__row">
          <td rowspan="1" colspan="1">
            <div class="cell">
              {{ data.label }} ({{ data.count }})
              <!-- imageUrl -->
              <el-popover v-if="data.imageUrl" width="400" trigger="hover">
                <el-image :src="data.imageUrl"></el-image>
                <el-link slot="reference" :underline="false">
                  <i class="el-icon-picture-outline"></i>
                </el-link>
              </el-popover>

              <!-- linkType && linkUrl -->
              <el-tooltip v-if="data.channel.linkType != 'None' || data.channel.linkUrl" effect="light" content="指定链接"
                placement="top">
                <i class="fa fa-external-link"></i>
              </el-tooltip>

            </div>
          </td>
          <td v-for="column in columns" v-if="column.isList && column.attributeName !== 'ChannelName'"
            :key="column.attributeName" rowspan="1" colspan="1">
            <div class="cell">
              <template v-if="column.attributeName === 'IndexName'">
                <el-tag size="mini" v-if="data.channel.indexName">
                  {{ data.channel.indexName }}
                </el-tag>
              </template>
              <template v-else-if="column.attributeName === 'GroupNames'">
                <template v-if="data.groupNames && groupNames" v-for="groupName in data.groupNames">
                  <el-tag v-if="groupNames.indexOf(groupName) !== -1" :key="groupName" size="mini" type="info">
                    {{ groupName }}
                  </el-tag>
                </template>
              </template>
              <template v-else-if="column.attributeName === 'ChannelTemplateId'">
                <el-link v-if="isTemplateEditable && data.channel.channelTemplateId > 0" :underline="false"
                  :href="getTemplateEditorUrl(true, data.channel.channelTemplateId)" target="_blank" type="primary">
                  {{ getTemplate(true, data.channel.channelTemplateId).templateName }}
                </el-link>
              </template>
              <template v-else-if="column.attributeName === 'ContentTemplateId'">
                <el-link v-if="isTemplateEditable && data.channel.contentTemplateId > 0" :underline="false"
                  :href="getTemplateEditorUrl(false, data.channel.contentTemplateId)" target="_blank" type="primary">
                  {{ getTemplate(false, data.channel.contentTemplateId).templateName }}
                </el-link>
              </template>
              <template v-else>
                <span v-html="data.channel.getEntityValue(column.attributeName)"></span>
              </template>
            </div>
          </td>
          <td rowspan="1" colspan="1" class="commands">
            <div class="cell">

              <el-link v-if="channelMenus" v-for="menu in channelMenus" :key="menu.id" :underline="false" type="primary"
                size="small" style="margin-left: 5px" v-on:click.stop.native="btnMenuClick(menu, data)">
                <i v-if="menu.iconClass" :class="menu.iconClass"></i>
                {{ menu.text }}
              </el-link>

              <el-link :underline="false" type="primary" size="small" style="margin-left: 5px"
                v-on:click.stop.native="btnEditClick(data)">
                编辑
              </el-link>
              <el-link :underline="false" type="primary" size="small" style="margin-left: 5px"
                :disabled="siteId == data.value" v-on:click.stop.native="btnDeleteClick(data)">
                删除
              </el-link>

            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</el-tree>

<el-row>
  <el-divider></el-divider>
  <div style="height: 10px"></div>
  <el-button size="small" type="primary" plain style="margin-left: 0px;" icon="el-icon-plus"
    v-on:click="btnAppendClick">
    添 加
  </el-button>
  <el-button size="small" type="primary" plain style="margin-left: 0px;" icon="el-icon-upload"
    v-on:click="btnImportClick">
    导 入
  </el-button>
  <el-button size="small" type="primary" plain style="margin-left: 0px;" :disabled="channelIds.length === 0"
    icon="el-icon-download" v-on:click="btnExportClick">
    导 出
  </el-button>
  <el-button size="small" type="primary" plain style="margin-left: 0px;" :disabled="channelIds.length === 0"
    icon="el-icon-right" v-on:click="btnTranslateClick">
    复 制
  </el-button>
  <!-- <el-button size="small" type="primary" plain style="margin-left: 0px;" :disabled="channelIds.length === 0"
    icon="el-icon-magic-stick" v-on:click="btnCreateClick">
    生 成
  </el-button> -->

  <div style="height: 5px"></div>
</el-row>

<el-drawer id="appendForm" v-if="appendForm" title="添加栏目" ref="appendPanel" :visible.sync="appendPanel" destroy-on-close
  :wrapperClosable="false" direction="rtl" size="90%">
  <div class="drawer__content">
    <el-form v-on:submit.native.prevent ref="appendForm" :model="appendForm" size="small" label-width="120px">
      <el-form-item label="父栏目" prop="parentIds" :rules="{ required: true, message: '请选择父栏目' }">
        <el-cascader-panel v-model="appendForm.parentIds" :options="root" :props="{ checkStrictly: true }"
          style="width: 100%;" placeholder="请选择父栏目">
        </el-cascader-panel>
      </el-form-item>
      <el-form-item label="栏目" prop="channels" :rules="{ required: true, message: '请输入栏目名称' }">
        <el-input v-model="appendForm.channels" type="textarea" rows="10" :autosize="{ minRows: 10, maxRows: 20}"
          placeholder="栏目之间用换行分割，下级栏目在栏目前添加“-”字符，如：&#10;栏目一&#10;-下级栏目&#10;--下下级栏目"></el-input>
      </el-form-item>

      <el-divider></el-divider>
      <div class="drawer__footer">
        <el-button type="primary" v-on:click="btnAppendSubmitClick" size="small">确 定</el-button>
        <el-button size="small" v-on:click="btnCancelClick">取 消</el-button>
      </div>
    </el-form>
  </div>
</el-drawer>

<el-drawer id="deleteForm" v-if="deleteForm" title="删除栏目" ref="deletePanel" :visible.sync="deletePanel" destroy-on-close
  :wrapperClosable="false" direction="rtl" size="80%">
  <div class="drawer__content">

    <el-alert type="warning">
      - 此操作将永久删除该栏目，包括所有下级栏目。
      <br>
      - 该栏目以及下级栏目所包含的所有文档将被删除。
    </el-alert>

    <br />
    <el-form v-on:submit.native.prevent size="mini" ref="deleteForm" :model="deleteForm" label-width="160px">
      <el-form-item>
        请输入以下信息以确认您的操作: <span style="color:#F56C6C">{{ deleteForm.label }}</span>
      </el-form-item>
      <el-form-item label="需要删除的栏目名称" prop="channelName" :rules="{ required: true, message: '请输入栏目名称' }">
        <el-input v-model="deleteForm.channelName" placeholder="请输入需要删除的栏目名称"></el-input>
      </el-form-item>

      <el-divider></el-divider>
      <div class="drawer__footer">
        <el-button type="danger" size="small" v-on:click="btnDeleteSubmitClick">删 除</el-button>
        <el-button size="small" v-on:click="btnCancelClick">取 消</el-button>
      </div>

    </el-form>
  </div>
</el-drawer>

<el-drawer id="importForm" v-if="importForm" title="导入栏目" ref="importPanel" :visible.sync="importPanel" destroy-on-close
  :wrapperClosable="false" direction="rtl" size="80%">
  <div class="drawer__content">
    <el-form v-on:submit.native.prevent ref="importForm" size="small" :model="importForm" label-width="160px">

      <el-form-item label="栏目压缩包" prop="fileName" :rules="{ required: true, message: '请上传栏目压缩包' }">
        <el-upload :drag="true" :limit="1" :action="uploadUrl" :auto-upload="true"
          :headers="{Authorization: 'Bearer ' + $token}" :file-list="importUploadList" :before-upload="uploadBefore"
          :on-progress="uploadProgress" :on-success="uploadSuccess" :on-error="uploadError" :multiple="false">
          <i class="el-icon-upload"></i>
          <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
        </el-upload>
      </el-form-item>

      <el-form-item label="父栏目" prop="channelIds" :rules="{ required: true, message: '请选择父栏目' }">
        <el-cascader v-model="importForm.channelIds" :options="root" :props="{ checkStrictly: true }"
          style="width: 100%;" placeholder="请选择父栏目">
        </el-cascader>
      </el-form-item>

      <el-form-item>
        <el-checkbox label="覆盖同名栏目" v-model="importForm.isOverride"></el-checkbox>
        <el-checkbox label="同时导入内容" v-model="importForm.isContents"></el-checkbox>
      </el-form-item>

      <el-divider></el-divider>
      <div class="drawer__footer">
        <el-button type="primary" size="small" v-on:click="btnImportSubmitClick">确 定</el-button>
        <el-button size="small" v-on:click="btnCancelClick">取 消</el-button>
      </div>

    </el-form>

  </div>
</el-drawer>

<el-drawer id="exportForm" v-if="exportForm" title="导出栏目" ref="exportPanel" :visible.sync="exportPanel" destroy-on-close
  :wrapperClosable="false" direction="rtl" size="80%">
  <div class="drawer__content">
    <el-form v-on:submit.native.prevent ref="exportForm" size="small" :model="exportForm" label-width="160px">

      <el-form-item>
        <el-checkbox label="同时导出内容" v-model="exportForm.isContents"></el-checkbox>
        <el-checkbox label="同时导出图片文件" v-if="exportForm.isContents" v-model="exportForm.isFileImages"></el-checkbox>
        <el-checkbox label="同时导出附件文件" v-if="exportForm.isContents" v-model="exportForm.isFileAttaches"></el-checkbox>
      </el-form-item>

      <el-divider></el-divider>
      <div class="drawer__footer">
        <el-button type="primary" size="small" v-on:click="btnExportSubmitClick">确 定</el-button>
        <el-button size="small" v-on:click="btnCancelClick">取 消</el-button>
      </div>

    </el-form>

  </div>
</el-drawer>

<el-drawer id="editForm" v-if="editPanel && form" title="编辑栏目" :visible.sync="editPanel" :destroy-on-close="true"
  :wrapperClosable="false" direction="rtl" size="90%">
  <div class="drawer__content">
    <el-form v-on:submit.native.prevent size="mini" ref="editForm" :model="form" label-width="200px">
      <el-form-item label="栏目名称" prop="channelName" :rules="{ required: true, message: '请输入栏目名称' }">
        <el-input v-model="form.channelName" placeholder="请输入栏目名称"></el-input>
      </el-form-item>
      <el-form-item label="栏目描述" prop="description">
        <el-input type="textarea" v-model="form.description" :autosize="{ minRows: 3, maxRows: 10}"></el-input>
      </el-form-item>

      <el-divider></el-divider>
      <div class="drawer__footer">
        <el-button type="primary" v-on:click="btnSaveClick" size="small">确 定</el-button>
        <el-button size="small" v-on:click="btnCancelClick">取 消</el-button>
      </div>
    </el-form>
  </div>
</el-drawer>

@section Scripts{
<script src="/sitefiles/assets/js/_partialForm.js" type="text/javascript"></script>
<script src="/sitefiles/assets/js/admin/document/channels.js" type="text/javascript"></script>
}