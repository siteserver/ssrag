@page
@{ Layout = "_Layout"; }
@section Styles{
<style>
  .plan-name {
    color: #28AB94;
    margin: 0 auto;
    width: 80%;
    white-space: nowrap;
    display: block;
    overflow: hidden;
    font-size: 16px;
    text-overflow: ellipsis;
  }

  .plan-price {
    margin-top: 10px;
  }

  .ga-border {
    height: 3px;
    width: 40px;
    background-color: #1b7fe6;
    margin: 10px auto;
  }

  .el-badge__content.is-fixed {
    right: 0px;
  }
</style>
}

<template v-if="pageType == 'selectType'">
  <el-alert>
    欢迎使用创建新知识库向导，请选择创建知识库的方式
  </el-alert>
  <div style="height: 10px"></div>

  <el-button v-on:click="btnCreateEmptyClick" plain size="small" type="primary">创建空知识库</el-button>
  <p class="tips">
    点击按钮创建空知识库，知识库的栏目、内容及模板需要手动添加
  </p>
  <el-button v-on:click="btnLocalClick" v-if="siteTemplates && siteTemplates.length > 0" plain size="small"
    type="primary">使用本地知识库模板创建知识库</el-button>
  <p class="tips" v-if="siteTemplates && siteTemplates.length > 0">
    点击按钮从本地知识库模板中选择并创建知识库
  </p>
  <el-button v-on:click="btnCloudClick" plain size="small" type="primary">使用在线知识库模板创建知识库</el-button>
  <p class="tips">
    点击按钮从官网模板中心中选择并创建知识库
  </p>
  <el-button v-on:click="btnUploadClick" plain size="small" type="primary">导入知识库模板创建知识库</el-button>
  <p class="tips">
    点击按钮上传并导入知识库模板并创建知识库
  </p>

  <el-drawer title="导入知识库模板" ref="uploadPanel" :visible.sync="uploadPanel" destroy-on-close direction="rtl" size="50%">
    <div class="drawer__content">
      <br />

      <el-form v-on:submit.native.prevent ref="uploadForm" label-width="200px">
        <el-upload :drag="true" :limit="1" :action="$urlUpload" :auto-upload="true"
          :headers="{Authorization: 'Bearer ' + $token}" :file-list="uploadList" :before-upload="uploadBefore"
          :on-progress="uploadProgress" :on-success="uploadSuccess" :on-error="uploadError" :multiple="false">
          <i class="el-icon-upload"></i>
          <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
          <div class="el-upload__tip" slot="tip">只能上传zip文件</div>
        </el-upload>
      </el-form>

    </div>
  </el-drawer>
</template>

<template v-else-if="pageType == 'selectLocal'">
  <el-alert>
    选中知识库模板后点击创建知识库按钮开始创建知识库
  </el-alert>
  <div style="height: 10px"></div>

  <el-table :data="siteTemplates" style="width: 100%">
    <el-table-column prop="siteTemplateName" label="知识库模板名称"></el-table-column>
    <el-table-column prop="directoryName" label="知识库模板文件夹"></el-table-column>
    <el-table-column prop="description" label="知识库模板介绍"></el-table-column>
    <el-table-column label="操作">
      <template slot-scope="scope">
        <el-link :underline="false"
          v-on:click="btnCreateLocalClick(scope.row.directoryName, scope.row.siteTemplateName)" type="primary">
          创建知识库
        </el-link>
      </template>
    </el-table-column>
  </el-table>
</template>

<template v-else-if="pageType == 'selectCloud'">
  <el-alert>
    选中知识库模板后点击创建知识库按钮开始创建知识库
  </el-alert>
  <div style="height: 10px"></div>

  <el-row>
    <el-col :span="20">
      <el-form v-on:submit.native.prevent :inline="true" size="mini">
        <el-form-item label="价格">
          <el-select v-on:change="priceChanged" v-model="price">
            <el-option value="" label="全部"></el-option>
            <el-option value="false" label="免费模板"></el-option>
            <el-option value="true" label="收费模板"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="排序">
          <el-select v-on:change="orderChanged" v-model="order">
            <el-option value="" label="默认"></el-option>
            <el-option value="UpdatedDate" label="更新时间"></el-option>
            <el-option value="AddDate" label="上传时间"></el-option>
            <el-option value="Price" label="价格"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-input v-model="word" style="width:200px" placeholder="请输入关键字..."></el-input>
        </el-form-item>
        <el-form-item>
          <el-button :underline="false" type="primary"
            v-on:click="btnRedirectClick(getUrl(page, word, tag, price, order))">搜索</el-button>
        </el-form-item>
      </el-form>
    </el-col>
    <el-col :span="4" align="right">
      <el-link :underline="false" type="primary" target="_blank" :href="getTemplatesUrl()">官网模板中心</el-link>
    </el-col>
  </el-row>
  <el-row>
    <el-tag type="success" style="cursor: pointer; margin: 0 3px 6px 0;" v-on:click="btnRedirectClick(getTagUrl(''))"
      :effect="!tag ? 'dark' : 'plain'">
      全部
    </el-tag>
    <el-tag v-for="tagName in tags" :key="tagName" type="success" style="cursor: pointer; margin: 0 3px 6px 0;"
      v-on:click="btnRedirectClick(getTagUrl(tagName))" :effect="tag == tagName ? 'dark' : 'plain'">
      {{ tagName }}
    </el-tag>
  </el-row>

  <div style="height: 10px"></div>

  <el-row>
    <el-col :span="6" v-for="(theme, index) in themes" :key="index">
      <el-card style="margin-bottom: 15px; margin-right: 15px;"
        :body-style="{ padding: '0px', textAlign: 'center', height: '450px', overflow: 'hidden' }">
        <el-image style="width: 100%; min-height: 120px; max-height: 240px; cursor: pointer;"
          v-on:click="btnImageClick(theme)" :src="getCoverUrl(theme)">
          <div slot="error" class="image-slot">
            <i class="el-icon-picture-outline"></i>
          </div>
        </el-image>
        <div style="padding: 14px;">

          <h4 class="text-center plan-name">
            {{ theme.name }}（{{ theme.updatedDate.substr(0, 10) }}）
            <div v-if="theme.price" class="plan-price">
              <el-badge v-if="isCreatable(theme)" value="已购">
                ￥{{ theme.price.toFixed(2) }}
              </el-badge>
              <span v-else>￥{{ theme.price.toFixed(2) }}</span>
            </div>
            <div v-else class="plan-price">免费</div>
          </h4>
          <div class="ga-border"></div>
          <p class="text-muted text-center" style="height: 45px; overflow: hidden;">
            <small>{{ theme.summary }}</small>
          </p>

          <div style="margin-top: 10px;">
            <el-button plain type="info" v-on:click="btnPreviewClick(theme)" size="mini" icon="el-icon-view"
              style="margin: 0 5px;">预览知识库</el-button>
            <el-button plain type="primary" v-if="isCreatable(theme)" v-on:click="btnCreateCloudClick(theme)"
              size="mini" icon="el-icon-circle-plus" style="margin: 0 5px;">
              创建知识库
            </el-button>
            <el-button plain type="primary" v-else v-on:click="btnBuyClick(theme.userName, theme.name)" size="mini"
              icon="el-icon-s-goods" style="margin: 0 5px;">
              购买并创建知识库
            </el-button>
          </div>
        </div>
      </el-card>
    </el-col>
  </el-row>

  <el-divider></el-divider>
  <div style="height: 10px"></div>

  <el-row align="center">
    <el-col :span="24" align="center">
      <el-pagination background layout="prev, pager, next" v-on:current-change="handlePageChange" :current-page="page"
        :page-size="12" :total="count">
      </el-pagination>
    </el-col>
  </el-row>

</template>

<template v-else-if="pageType == 'submit'">

  <el-alert v-if="this.form.createType == 'cloud'">
    使用在线知识库模板创建知识库，知识库模板：<el-link size="mini" type="primary" :underline="false"
      :href="this.getDisplayUrl(this.form.cloudThemeUserName, this.form.cloudThemeName)" target="_blank">{{
      this.form.cloudThemeName }}</el-link>
  </el-alert>
  <el-alert v-else-if="this.form.createType === 'local'">
    使用本地知识库模板创建知识库，知识库模板：{{this.form.localDirectoryName}}
  </el-alert>
  <el-alert v-else="this.form.createType">
    创建空知识库（不使用知识库模板）
  </el-alert>

  <div style="height: 10px"></div>

  <el-form v-on:submit.native.prevent size="small" ref="form" :model="form" label-width="150px">
    <el-form-item label="知识库名称" prop="siteName" :rules="{ required: true, message: '请输入知识库名称' }">
      <el-input v-model="form.siteName" placeholder="请输入知识库名称"></el-input>
    </el-form-item>
    <el-form-item v-if="!rootExists" label="知识库级别" prop="root" :rules="{ required: true, message: '请选择知识库级别' }">
      <el-radio-group v-model="form.root">
        <el-radio :label="true">主站</el-radio>
        <el-radio :label="false">子站</el-radio>
      </el-radio-group>
      <div class="tips">主站文件夹路径为系统根目录</div>
    </el-form-item>
    <el-form-item v-if="!form.root" label="上级知识库">
      <el-cascader ref="parentIds" v-model="parentIds" :options="sites" :props="{ checkStrictly: true }" filterable
        placeholder="请选择上级知识库">
      </el-cascader>
    </el-form-item>
    <el-form-item v-if="!form.root" label="文件夹名称" prop="siteDir" :rules="{ required: true, message: '请输入文件夹名称' }">
      <el-input v-model="form.siteDir" placeholder="请输入文件夹名称"></el-input>
      <div class="tips">实际在服务器中保存此网站的文件夹名称，此路径必须以英文或拼音命名</div>
    </el-form-item>

    <el-form-item v-if="form.createType == 'local' || form.createType == 'cloud'" label="知识库模板导入选项">
      <el-checkbox v-model="form.isImportContents">导入栏目及内容</el-checkbox>
      <el-checkbox v-model="form.isImportTableStyles">导入表虚拟字段</el-checkbox>
    </el-form-item>

    <el-divider></el-divider>
    <div style="height: 10px"></div>
    <el-form-item>
      <el-button type="primary" v-on:click="btnSubmitClick" size="small">创建知识库</el-button>
      <el-button size="small" v-on:click="btnCancelClick">返 回</el-button>
    </el-form-item>

  </el-form>
</template>

<template v-else-if="pageType == 'process'">
  <div style="margin: 1em 2em 2em 2em;">
    <div style="padding: 5px;">任务完成:
      <font id="prgressBarPercetage" v-html="parseInt(current * 100 / total) + ''">0</font>%
    </div>
    <div style="width: 350px; height: 25px;  background: #eee;">
      <div :style="{width: parseInt(current * 350 / total) + 'px'}"
        style="width: 0; height: 25px; background: #1b7fe6;"></div>
    </div>
    <div class="tips" style="margin: 5px">{{message || '任务初始化...'}}</div>
  </div>
</template>

<template v-else-if="pageType == 'error'">
  <el-alert title="错误提示" type="error" :description="errorMessage" show-icon>
  </el-alert>
</template>

@section Scripts{
<script src="/sitefiles/assets/js/admin/settings/sitesAdd.js" type="text/javascript"></script>
}